name: 'ðŸ“‹ Gemini Scheduled Issue Triage'

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  pull_request:
    branches:
      - 'main'
      - 'gemini-cli'
      - 'release/**/*'
    paths:
      - '.github/workflows/gemini-scheduled-triage.yml'
  push:
    branches:
      - 'main'
      - 'gemini-cli'
      - 'release/**/*'
    paths:
      - '.github/workflows/gemini-scheduled-triage.yml'
  workflow_dispatch:

concurrency:
  group: '${{ github.workflow }}'
  cancel-in-progress: true

# Permissions for workflow and nested workflow calls
permissions:
  contents: 'read'
  issues: 'write'
  pull-requests: 'write'
  id-token: 'write'

defaults:
  run:
    shell: 'bash'

jobs:
  find-issues:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 5
    permissions:
      contents: 'read'
      issues: 'read'
    outputs:
      issues: '${{ steps.find_issues.outputs.issues }}'
      has_issues: '${{ steps.find_issues.outputs.has_issues }}'
    steps:
      - name: 'Find untriaged issues'
        id: 'find_issues'
        env:
          GITHUB_REPOSITORY: '${{ github.repository }}'
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN || github.token }}'
        run: |-
          echo 'ðŸ” Finding unlabeled issues and issues marked for triage...'
          ISSUES="$(gh issue list \
            --state 'open' \
            --search 'no:label label:"status/needs-triage"' \
            --json number,title,body \
            --limit '20' \
            --repo "${GITHUB_REPOSITORY}"
          )"

          ISSUE_COUNT="$(echo "${ISSUES}" | jq 'length')"
          echo "âœ… Found ${ISSUE_COUNT} issue(s) to triage!"

          if [ "${ISSUE_COUNT}" -eq 0 ]; then
            echo "has_issues=false" >> "${GITHUB_OUTPUT}"
            echo "issues=[]" >> "${GITHUB_OUTPUT}"
          else
            echo "has_issues=true" >> "${GITHUB_OUTPUT}"
            # Create matrix-compatible output (array of objects with issue_number, issue_title, issue_body)
            MATRIX_ISSUES="$(echo "${ISSUES}" | jq -c '[.[] | {issue_number: .number, issue_title: .title, issue_body: .body}]')"
            echo "issues=${MATRIX_ISSUES}" >> "${GITHUB_OUTPUT}"
          fi

  triage-issues:
    needs: 'find-issues'
    if: ${{ needs.find-issues.outputs.has_issues == 'true' }}
    strategy:
      max-parallel: 3
      fail-fast: false
      matrix:
        issue: ${{ fromJson(needs.find-issues.outputs.issues) }}
    uses: './.github/workflows/gemini-triage.yml'
    with:
      issue_number: ${{ matrix.issue.issue_number }}
      issue_title: ${{ matrix.issue.issue_title }}
      issue_body: ${{ matrix.issue.issue_body }}
      skip_comment: true
    secrets: inherit
